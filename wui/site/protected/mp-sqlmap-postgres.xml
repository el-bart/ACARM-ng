<?xml version="1.0" encoding="utf-8" ?>
<sqlMapConfig>

  <cacheModel id="querycache" implementation="LRU" >
    <flushInterval hours="1"/>
    <property name="CacheSize" value="100"/>
  </cacheModel>


  <!-- Queries for single items -->

  <select id="SelectReportedHost" resultClass="CReportedHostEntry" parameterClass="int">
    SELECT r.id AS id, r.role AS role, h.ip AS ip, h.mask AS mask, h.os AS os, h.name AS name, u.name as ref_name, u.url AS ref_url FROM ( reported_hosts as r LEFT JOIN hosts as h ON r.id_host=h.id ) LEFT JOIN reference_urls as u ON r.id_ref=u.id WHERE r.id=#value#
  </select>

  <select id="SelectReportedService" resultClass="CReportedServiceEntry" parameterClass="int">
    SELECT s.id AS id, s.name AS name, s.port AS port, s.protocol AS protocol, u.name AS ref_name, u.url AS ref_url FROM ( reported_services AS r LEFT JOIN services AS s ON r.id_service=s.id ) LEFT JOIN reference_urls AS u ON r.id_ref=u.id WHERE s.id=#value# ORDER BY name
  </select>

  <select id="SelectReportedProcess" resultClass="CReportedProcessEntry" parameterClass="int">
    SELECT r.id AS id, p.name AS name, p.path AS path, p.md5 AS md5, r.pid AS pid, r.uid AS uid, r.username AS username, r.arguments AS arguments, u.name AS ref_name, u.url AS ref_url FROM ( reported_procs AS r LEFT JOIN procs AS p ON r.id_proc=p.id ) LEFT JOIN reference_urls AS u ON r.id_ref=u.id WHERE r.id=#value# ORDER BY name
  </select>

  <select id="SelectAlertAnalyzers" resultClass="CLinkPair" parameterClass="int">
    SELECT aa.id_analyzer AS id, an.name AS name FROM alert_analyzers AS aa LEFT JOIN analyzers AS an ON aa.id_analyzer=an.id WHERE aa.id_alert=#value#
  </select>

  <select id="SelectAlertSourceHosts" resultClass="CLinkPair" parameterClass="int">
    SELECT r.id AS id, h.ip AS name FROM reported_hosts AS r LEFT JOIN hosts AS h ON r.id_host=h.id WHERE r.id_alert=#value# AND r.role='src' ORDER BY name
  </select>

  <select id="SelectAlertDestinationHosts" resultClass="CLinkPair" parameterClass="int">
    SELECT r.id AS id, h.ip AS name FROM reported_hosts AS r LEFT JOIN hosts AS h ON r.id_host=h.id WHERE r.id_alert=#value# AND r.role='dst' ORDER BY name
  </select>

  <select id="SelectReportedHostsProcesses" resultClass="CLinkPair" parameterClass="int">
    SELECT r.id AS id, p.name AS name FROM reported_procs AS r LEFT JOIN procs as p ON r.id_proc=p.id WHERE r.id_reported_host=#value# ORDER BY name
  </select>

  <select id="SelectReportedHostsServices" resultClass="CLinkPair" parameterClass="int">
    SELECT r.id_service AS id, s.name AS name FROM reported_services AS r LEFT JOIN services as s ON r.id_service=s.id WHERE r.id_reported_host=#value# ORDER BY name
  </select>

  <select id="SelectAlert" resultClass="CAlertEntry" parameterClass="int">
    SELECT a.name, a.detect_time AS detect, a.create_time AS create, a.description as description, a.certanity AS certainty, s.name AS severity, h1.ip AS src_ip, h2.ip AS dst_ip 
      FROM alerts AS a,hosts AS h1,hosts AS h2, severities AS s
      WHERE h1.id_alert=h2.id_alert AND h1.id_alert=a.id AND h1.role='src' AND h2.role='dst' AND s.id=a.id_severity AND a.id=#VALUE#;
  </select>

  <select id="SelectMetaAlertID" resultClass="CMetaAlertEntry" parameterClass="int">
    SELECT ma.id AS id, ma.name AS name, ma.create_time AS create_time, ma.last_update_time AS last_update_time, ma.severity_delta AS severity_delta, ma.certainty_delta AS certainty_delta, m.id_alert AS id_alert 
      FROM meta_alerts AS ma LEFT JOIN alert_to_meta_alert_map AS m ON m.id_meta_alert=ma.id 
      WHERE id=#value#
  </select>

  <select id="SelectMetaAlertSysID" resultClass="CMetaAlertEntry" parameterClass="int">
    SELECT ma.id AS id, ma.name AS name, ma.create_time AS create_time, ma.last_update_time AS last_update_time, ma.severity_delta AS severity_delta, ma.certainty_delta AS certainty_delta, m.id_alert AS id_alert 
      FROM meta_alerts AS ma LEFT JOIN alert_to_meta_alert_map AS m ON m.id_meta_alert=ma.id 
      WHERE ma.sys_id=#value#
  </select>

  <select id="SelectAnalyzer" resultClass="CAnalyzerListEntry" parameterClass="int">
    SELECT * FROM analyzers WHERE id=#value#
  </select>

  <select id="MapSysIDtoDatabaseID" resultClass="int" parameterClass="int">
    SELECT id FROM meta_alerts WHERE sys_id=#value#
  </select>

  <select id="SelectMetaAlertsChildren" resultClass="CLinkTriple" parameterClass="int">
    <!--SELECT ma.id, ma.name FROM meta_alerts AS ma RIGHT JOIN meta_alerts_tree AS t ON ma.id=t.id_child WHERE t.id_node=#value#-->
    SELECT ma.id as metaalertid, ma.name as name, g.id_alert as alertid FROM meta_alerts AS ma RIGHT JOIN meta_alerts_tree AS t ON ma.id=t.id_child LEFT JOIN alert_to_meta_alert_map as g ON g.id_meta_alert=ma.id WHERE t.id_node=#value#
  </select>

  <!-- Queries for tables' sizes -->

  <select id="SelectUsersCount" resultClass="int">
    SELECT count(*) FROM wui_users
  </select>

  <select id="SelectAnalyzersCount" resultClass="int">
    SELECT count(*) FROM analyzers
  </select>

  <select id="SelectWUILogsCount" resultClass="int">
    SELECT count(*) FROM logs
  </select>

  <select id="SelectAlertsSummaryCount" resultClass="int">
    SELECT count(*) FROM alerts
  </select>

  <select id="SelectAlertsSummaryRangeCount" resultClass="int" parameterClass="CParamRange">
    <![CDATA[
      select count(*) from
      (
          select ad.id AS id, ad.name AS name, ad.create_time AS create_time, s.name AS severity from  
          (
              (select * from alerts WHERE create_time<=#date_to# AND create_time>=#date_from#) AS ad
              LEFT JOIN
              severities AS s
              ON s.id=ad.id_severity
          )  WHERE
            (s.name='critical' AND #severities# LIKE '%critical%')
         OR (s.name='error' AND #severities# LIKE '%error%')
         OR (s.name='problem' AND #severities# LIKE '%problem%')
         OR (s.name='warning' AND #severities# LIKE '%warning%')
         OR (s.name='debug' AND #severities# LIKE '%debug%')
         OR (s.name='info' AND #severities# LIKE '%info%')
     ) AS x
     JOIN
     (SELECT h1.id_alert AS id_alert FROM
         (select * FROM hosts WHERE (hosts.ip=#src# OR 1=#ignoresrc#) AND role='src') AS h1
         JOIN
         (select * FROM hosts WHERE (hosts.ip=#dst# OR 1=#ignoredst#) AND role='dst') AS h2
         ON h1.id_alert=h2.id_alert
     ) AS h
     ON h.id_alert=x.id
    ]]>
  </select>

  <select id="SelectMetaAlertsSummaryCount" resultClass="int">
    SELECT count(*) FROM meta_alerts
  </select>

  <select id="SelectMetaAlertsRootsCount" resultClass="int">
    SELECT count(*) FROM meta_alerts WHERE id NOT IN ( SELECT id_child FROM meta_alerts_tree ) ORDER BY create_time DESC limit #limit# offset #offset# <!--unsure-->
  </select>

  <!-- Queries for lists of items -->

  <select id="SelectUsers" resultClass="CUserRecord" parameterClass="CParamLimitOffset">
    SELECT * FROM wui_users ORDER BY login ASC limit #limit# offset #offset#
  </select>

  <select id="SelectAnalyzers" resultClass="CAnalyzerListEntry" parameterClass="CParamLimitOffset">
    SELECT * FROM analyzers ORDER BY name,ip ASC limit #limit# offset #offset#
  </select>

  <select id="SelectAnalyzersForAlert" resultClass="CAnalyzerListEntry" parameterClass="int">
    SELECT name, ip, version, os FROM alert_analyzers JOIN analyzers ON alert_analyzers.id_analyzer=analyzers.id WHERE alert_analyzers.id_alert=#VALUE#
  </select>

  <select id="SelectHostsForAlert" resultClass="CReportedHostEntry" parameterClass="int">
    SELECT hosts.name,ip,role,os,hosts.id FROM alerts JOIN hosts ON hosts.id_alert=alerts.id WHERE alerts.id=#VALUE#
  </select>

  <select id="SelectWUILogs" resultClass="CLogEntry" parameterClass="CParamLimitOffset">
    SELECT u.id AS id, u.login AS login, l.ctime AS ctime, l.msg AS msg FROM logs AS l LEFT JOIN wui_users AS u ON l.id_wui_user=u.id ORDER BY ctime DESC limit #limit# offset #offset#
  </select>

  <select id="SelectAlertsSummary" resultClass="CAlertListEntry" parameterClass="CParamLimitOffset">
    SELECT a.id AS id, a.name AS name, a.create_time AS create_time, s.name || ' (' || s.level || ')' AS severity FROM alerts AS a LEFT JOIN severities AS s ON a.id_severity=s.id ORDER BY create_time DESC limit #limit# offset #offset#
  </select>

  <select id="SelectAlertsSummaryRange" resultClass="CAlertListEntry" parameterClass="CParamRange">
    <![CDATA[
      select id, name, create_time, severity from
      (
          select ad.id AS id, ad.name AS name, ad.create_time AS create_time, s.name AS severity from  
          (
              (select * from alerts WHERE create_time<=#date_to# AND create_time>=#date_from#) AS ad
              LEFT JOIN
              severities AS s
              ON s.id=ad.id_severity
          )  WHERE
            (s.name='critical' AND #severities# LIKE '%critical%')
         OR (s.name='error' AND #severities# LIKE '%error%')
         OR (s.name='problem' AND #severities# LIKE '%problem%')
         OR (s.name='warning' AND #severities# LIKE '%warning%')
         OR (s.name='debug' AND #severities# LIKE '%debug%')
         OR (s.name='info' AND #severities# LIKE '%info%')
     ) AS x
     JOIN
     (SELECT h1.id_alert AS id_alert FROM
         (select * FROM hosts WHERE (hosts.ip=#src# OR 1=#ignoresrc#) AND role='src') AS h1
         JOIN
         (select * FROM hosts WHERE (hosts.ip=#dst# OR 1=#ignoredst#) AND role='dst') AS h2
         ON h1.id_alert=h2.id_alert
     ) AS h
     ON h.id_alert=x.id
     ORDER BY x.create_time
     LIMIT #limit#
     OFFSET #offset#
    ]]>
  </select>

  <select id="SelectMetaAlertsSummary" resultClass="CMetaAlertSummaryEntry" parameterClass="CParamLimitOffset">
    SELECT id, name, create_time FROM meta_alerts ORDER BY create_time DESC limit #limit# offset #offset#
  </select>

  <select id="SelectMetaAlertRoots" resultClass="CMetaAlertSummaryEntry" parameterClass="CParamLimitOffset">
    SELECT id, name, create_time FROM meta_alerts WHERE id NOT IN ( SELECT id_child FROM meta_alerts_tree ) ORDER BY create_time DESC limit #limit# offset #offset#
  </select>

<!-- Queries for Data Mining -->

  <select id="DMSeveritiesIP" resultClass="CDMPair" parameterClass="CParamRange"  cacheModel="querycache">
    <![CDATA[
    SELECT alerts.name as key,count(*) as value FROM
      (SELECT a.id,name FROM
         (select id,id_severity FROM alerts WHERE create_time<=#date_to# AND create_time>=#date_from#) AS a
      JOIN severities ON a.id_severity=severities.id
      WHERE (severities.name='critical' AND #severities# LIKE '%critical%')
         OR (severities.name='error' AND #severities# LIKE '%error%')
         OR (severities.name='problem' AND #severities# LIKE '%problem%')
         OR (severities.name='warning' AND #severities# LIKE '%warning%')
         OR (severities.name='debug' AND #severities# LIKE '%debug%')
         OR (severities.name='info' AND #severities# LIKE '%info%')
      )AS alerts
    JOIN hosts as h1 ON alerts.id=h1.id_alert AND h1.role='src'
    JOIN hosts as h2 ON alerts.id=h2.id_alert AND h2.role='dst'
    WHERE (h1.ip=#src# OR 1=#ignoresrc#) AND (h2.ip=#dst# OR 1=#ignoredst#)
   GROUP BY (key);
    ]]>
  </select>

<!-- The same query but with removed two joins for the sake of performance -->
  <select id="DMSeverities" resultClass="CDMPair" parameterClass="CParamRange"  cacheModel="querycache">
    <![CDATA[
    SELECT alerts.name as key,count(*) as value FROM
      (SELECT a.id,name FROM
         (select id,id_severity FROM alerts WHERE create_time<=#date_to# AND create_time>=#date_from#) AS a
      JOIN severities ON a.id_severity=severities.id
      WHERE (severities.name='critical' AND #severities# LIKE '%critical%')
         OR (severities.name='error' AND #severities# LIKE '%error%')
         OR (severities.name='problem' AND #severities# LIKE '%problem%')
         OR (severities.name='warning' AND #severities# LIKE '%warning%')
         OR (severities.name='debug' AND #severities# LIKE '%debug%')
         OR (severities.name='info' AND #severities# LIKE '%info%')
      )AS alerts
    GROUP BY (key);
    ]]>
  </select>


  <select id="DMAlertCountTimeSeries" resultClass="CDMPair" parameterClass="CParamRange"  cacheModel="querycache">
    <![CDATA[
    SELECT key,value FROM 
      (SELECT date_trunc('day', create_time) AS key FROM
        alerts WHERE create_time>=#date_from# AND create_time<=#date_to# GROUP BY key) AS a
        LEFT JOIN (SELECT date_trunc('day', create_time) AS date2, count(*) AS value FROM
        alerts LEFT JOIN severities AS s ON alerts.id_severity=s.id WHERE s.name=#severities# GROUP BY date2) AS b ON a.key=b.date2 ORDER BY key;
    ]]>
  </select>

  <select id="DMAlertTypes" resultClass="CDMPair" parameterClass="CParamRange"  cacheModel="querycache">
    <![CDATA[
    SELECT name AS key,count(name) AS value FROM Alerts WHERE create_time<=#date_to# AND create_time>=#date_from# GROUP BY name ORDER BY count(name) DESC;
    ]]>
  </select>

  <select id="DMMetaAlertCountTimeSeries" resultClass="CDMPair" parameterClass="CParamRange"  cacheModel="querycache">
    <![CDATA[
    SELECT date_trunc('day', create_time) AS key ,count(*) AS value FROM meta_alerts WHERE create_time<=#date_to# AND create_time>=#date_from# AND severity_delta>=0 GROUP BY key ORDER BY key;
    ]]>
  </select>

  <!-- HeatMap Query -->
  <select id="DMHeatMapRange" resultClass="CDMHeatMap" parameterClass="CDMPair">
    <![CDATA[
       select a.ip as source, b.ip as destination, count(*) as count from hosts as a JOIN hosts as b ON a.id_alert=b.id_alert where a.role='src' AND b.role='dst' AND a.id_alert>#key# AND a.id_alert<#value# group by a.ip, b.ip;
     ]]>
  </select>

  <select id="DMHeatMapHostcount" resultClass="CDMPair">
    select min(id_alert) as key,max(id_alert) as value from hosts;
  </select>

  <select id="DMHeatMapNumAlerts" resultClass="int" parameterClass="CDMQuadruple">
    <![CDATA[
       select count(*) as count from hosts as a JOIN hosts as b ON a.id_alert=b.id_alert where a.role='src' AND b.role='dst' AND a.id_alert>#value1# AND a.id_alert<#value2# AND a.ip=#value3# AND b.ip=#value4#;
     ]]>
  </select>

</sqlMapConfig>
